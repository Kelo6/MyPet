<!--pages/reminders/reminders.wxml-->
<view class="container">
  <!-- å¤´éƒ¨åˆ‡æ¢åŒºåŸŸ -->
  <view class="header-section">
    <view class="view-toggle">
      <view 
        class="toggle-item {{currentView === 'calendar' ? 'active' : ''}}"
        bindtap="onViewChange"
        data-view="calendar"
      >
        <text class="toggle-icon">ğŸ“…</text>
        <text class="toggle-text">æ—¥å†è§†å›¾</text>
      </view>
      <view 
        class="toggle-item {{currentView === 'list' ? 'active' : ''}}"
        bindtap="onViewChange"
        data-view="list"
      >
        <text class="toggle-icon">ğŸ“‹</text>
        <text class="toggle-text">åˆ—è¡¨è§†å›¾</text>
      </view>
    </view>

    <!-- ç­›é€‰é€‰é¡¹ -->
    <view class="filter-section">
      <scroll-view class="filter-scroll" scroll-x="true">
        <view class="filter-chips">
          <view 
            class="filter-chip {{selectedType === 'all' ? 'active' : ''}}"
            bindtap="onTypeFilter"
            data-type="all"
          >
            <text class="chip-text">å…¨éƒ¨</text>
            <view wx:if="{{stats.total > 0}}" class="chip-badge">{{stats.total}}</view>
          </view>
          <view 
            class="filter-chip {{selectedType === 'vaccine' ? 'active' : ''}}"
            bindtap="onTypeFilter"
            data-type="vaccine"
          >
            <text class="chip-icon">ğŸ’‰</text>
            <text class="chip-text">ç–«è‹—</text>
            <view wx:if="{{stats.vaccine > 0}}" class="chip-badge vaccine">{{stats.vaccine}}</view>
          </view>
          <view 
            class="filter-chip {{selectedType === 'deworm' ? 'active' : ''}}"
            bindtap="onTypeFilter"
            data-type="deworm"
          >
            <text class="chip-icon">ğŸ’Š</text>
            <text class="chip-text">é©±è™«</text>
            <view wx:if="{{stats.deworm > 0}}" class="chip-badge deworm">{{stats.deworm}}</view>
          </view>
          <view 
            class="filter-chip {{selectedStatus === 'pending' ? 'active' : ''}}"
            bindtap="onStatusFilter"
            data-status="pending"
          >
            <text class="chip-icon">â°</text>
            <text class="chip-text">å¾…å¤„ç†</text>
            <view wx:if="{{stats.pending > 0}}" class="chip-badge pending">{{stats.pending}}</view>
          </view>
          <view 
            class="filter-chip {{selectedStatus === 'sent' ? 'active' : ''}}"
            bindtap="onStatusFilter"
            data-status="sent"
          >
            <text class="chip-icon">ğŸ“¤</text>
            <text class="chip-text">å·²å‘é€</text>
            <view wx:if="{{stats.sent > 0}}" class="chip-badge sent">{{stats.sent}}</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-section">
    <!-- æ—¥å†è§†å›¾ -->
    <view wx:if="{{currentView === 'calendar'}}" class="calendar-view">
      <!-- æœˆä»½å¯¼èˆª -->
      <view class="calendar-header">
        <view class="month-nav">
          <view class="nav-btn" bindtap="onPrevMonth">
            <text class="nav-icon">â€¹</text>
          </view>
          <view class="month-title">
            <text class="month-text">{{formatMonth(currentDate)}}</text>
          </view>
          <view class="nav-btn" bindtap="onNextMonth">
            <text class="nav-icon">â€º</text>
          </view>
        </view>
        <view class="today-btn" bindtap="onToday">
          <text class="today-text">ä»Šå¤©</text>
        </view>
      </view>

      <!-- æ˜ŸæœŸæ ‡é¢˜ -->
      <view class="weekdays">
        <view wx:for="{{weekdays}}" wx:key="*this" class="weekday">
          <text class="weekday-text">{{item}}</text>
        </view>
      </view>

      <!-- æ—¥å†ç½‘æ ¼ -->
      <view class="calendar-grid">
        <view 
          wx:for="{{calendarDays}}" 
          wx:key="date"
          class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.hasReminders ? 'has-reminders' : ''}}"
          bindtap="onDaySelect"
          data-date="{{item.date}}"
        >
          <text class="day-number">{{item.day}}</text>
          <view wx:if="{{item.reminders.length > 0}}" class="day-indicators">
            <view 
              wx:for="{{item.reminders}}" 
              wx:key="_id"
              wx:for-item="reminder"
              class="reminder-dot {{reminder.type}} {{reminder.status}}"
            ></view>
          </view>
        </view>
      </view>

      <!-- é€‰ä¸­æ—¥æœŸçš„æé†’ -->
      <view wx:if="{{selectedDateReminders.length > 0}}" class="selected-date-reminders">
        <view class="selected-date-header">
          <text class="selected-date-title">{{formatSelectedDate(selectedDate)}} çš„æé†’</text>
        </view>
        <view class="reminder-list">
          <view 
            wx:for="{{selectedDateReminders}}" 
            wx:key="_id"
            class="reminder-item {{item.status}}"
            bindtap="onReminderDetail"
            data-reminder="{{item}}"
          >
            <view class="reminder-icon {{item.type}}">
              <text class="icon-text">{{item.type === 'vaccine' ? 'ğŸ’‰' : 'ğŸ’Š'}}</text>
            </view>
            <view class="reminder-content">
              <text class="reminder-title">{{getReminderTitle(item)}}</text>
              <text class="reminder-pet">{{getPetName(item.petId)}}</text>
            </view>
            <view class="reminder-status">
              <text class="status-text">{{getStatusText(item.status)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ—è¡¨è§†å›¾ -->
    <view wx:if="{{currentView === 'list'}}" class="list-view">
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{filteredReminders.length === 0}}" class="empty-container">
        <empty-state
          icon="ğŸ””"
          title="{{getEmptyTitle()}}"
          description="{{getEmptyDescription()}}"
          action-text="ç”Ÿæˆæé†’"
          bind:action="onGenerateReminders"
        />
      </view>

      <!-- æé†’åˆ—è¡¨ -->
      <view wx:else class="reminders-list">
        <!-- æŒ‰æ—¥æœŸåˆ†ç»„ -->
        <view wx:for="{{groupedReminders}}" wx:key="date" class="date-group">
          <view class="date-header">
            <text class="date-title">{{formatGroupDate(item.date)}}</text>
            <text class="date-count">{{item.reminders.length}}ä¸ªæé†’</text>
          </view>

          <view class="group-reminders">
            <view 
              wx:for="{{item.reminders}}" 
              wx:key="_id"
              wx:for-item="reminder"
              class="reminder-card {{reminder.status}} {{reminder.type}}"
              bindtap="onReminderDetail"
              data-reminder="{{reminder}}"
            >
              <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
              <view class="status-indicator {{reminder.status}}">
                <text class="status-dot"></text>
              </view>

              <!-- æé†’å†…å®¹ -->
              <view class="card-content">
                <view class="card-header">
                  <view class="reminder-info">
                    <text class="reminder-title">{{getReminderTitle(reminder)}}</text>
                    <text class="reminder-subtitle">{{getPetName(reminder.petId)}}</text>
                  </view>
                  <view class="type-badge {{reminder.type}}">
                    <text class="badge-icon">{{reminder.type === 'vaccine' ? 'ğŸ’‰' : 'ğŸ’Š'}}</text>
                    <text class="badge-text">{{reminder.type === 'vaccine' ? 'ç–«è‹—' : 'é©±è™«'}}</text>
                  </view>
                </view>

                <view class="card-meta">
                  <view class="time-info">
                    <text class="fire-time">{{formatFireTime(reminder.fireAt)}}</text>
                    <text class="relative-time">{{getRelativeTime(reminder.fireAt)}}</text>
                  </view>
                  <view class="status-info">
                    <text class="status-label {{reminder.status}}">{{getStatusText(reminder.status)}}</text>
                  </view>
                </view>

                <!-- æ“ä½œæŒ‰é’® -->
                <view class="card-actions" wx:if="{{reminder.status === 'pending'}}">
                  <button 
                    class="action-btn secondary"
                    bindtap="onSnoozeReminder"
                    data-reminder="{{reminder}}"
                    catch:tap="stopPropagation"
                  >
                    ç¨åæé†’
                  </button>
                  <button 
                    class="action-btn primary"
                    bindtap="onSubscribeMessage"
                    data-reminder="{{reminder}}"
                    catch:tap="stopPropagation"
                  >
                    è®¢é˜…æé†’
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <button class="action-button secondary" bindtap="requestAllSubscriptions">
      <text class="button-icon">ğŸ“¢</text>
      <text class="button-text">æ‰¹é‡è®¢é˜…</text>
    </button>
    <button class="action-button primary" bindtap="onAddReminder">
      <text class="button-icon">â•</text>
      <text class="button-text">æ·»åŠ æé†’</text>
    </button>
  </view>

  <!-- ç¨åæé†’å¼¹çª— -->
  <view wx:if="{{showSnoozeModal}}" class="modal-overlay" bindtap="hideSnoozeModal">
    <view class="modal-content" catch:tap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¨åæé†’</text>
        <view class="modal-close" bindtap="hideSnoozeModal">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="snooze-options">
          <view 
            wx:for="{{snoozeOptions}}" 
            wx:key="value"
            class="snooze-option {{selectedSnooze === item.value ? 'active' : ''}}"
            bindtap="onSnoozeSelect"
            data-value="{{item.value}}"
          >
            <text class="option-icon">{{item.icon}}</text>
            <text class="option-text">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="modal-btn secondary" bindtap="hideSnoozeModal">å–æ¶ˆ</button>
        <button 
          class="modal-btn primary" 
          bindtap="confirmSnooze"
          disabled="{{!selectedSnooze}}"
        >
          ç¡®è®¤
        </button>
      </view>
    </view>
  </view>

  <!-- è®¢é˜…æ¶ˆæ¯æˆæƒå¼¹çª— -->
  <view wx:if="{{showSubscribeModal}}" class="modal-overlay" bindtap="hideSubscribeModal">
    <view class="modal-content subscribe-modal" catch:tap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è®¢é˜…æ¶ˆæ¯æé†’</text>
        <view class="modal-close" bindtap="hideSubscribeModal">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="subscribe-info">
          <view class="info-icon">ğŸ””</view>
          <text class="info-title">å¼€å¯æ¶ˆæ¯æé†’</text>
          <text class="info-desc">æˆ‘ä»¬å°†åœ¨é€‚å½“çš„æ—¶å€™å‘æ‚¨å‘é€å® ç‰©å¥åº·æé†’ï¼Œå¸®åŠ©æ‚¨ä¸é”™è¿‡é‡è¦çš„ç–«è‹—å’Œé©±è™«æ—¶é—´ã€‚</text>
        </view>
        
        <view class="reminder-preview">
          <text class="preview-title">æé†’å†…å®¹é¢„è§ˆï¼š</text>
          <view class="preview-content">
            <text class="preview-text">{{previewReminder.title}}</text>
            <text class="preview-time">æé†’æ—¶é—´ï¼š{{formatFireTime(previewReminder.fireAt)}}</text>
          </view>
        </view>

        <view class="subscribe-tips">
          <text class="tips-title">æ¸©é¦¨æç¤ºï¼š</text>
          <text class="tips-item">â€¢ æ‚¨å¯ä»¥éšæ—¶åœ¨è®¾ç½®ä¸­å…³é—­æé†’</text>
          <text class="tips-item">â€¢ æˆ‘ä»¬ä¸ä¼šå‘é€å¹¿å‘Šæˆ–æ— å…³ä¿¡æ¯</text>
          <text class="tips-item">â€¢ æé†’æ¶ˆæ¯å®Œå…¨å…è´¹</text>
        </view>
      </view>
      <view class="modal-actions">
        <button class="modal-btn secondary" bindtap="hideSubscribeModal">æš‚ä¸è®¢é˜…</button>
        <button 
          class="modal-btn primary" 
          bindtap="confirmSubscribe"
          loading="{{subscribing}}"
        >
          ç«‹å³è®¢é˜…
        </button>
      </view>
    </view>
  </view>
</view>
