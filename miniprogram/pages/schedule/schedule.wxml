<!--pages/schedule/schedule.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ç­›é€‰åŒºåŸŸ -->
  <view class="header-section">
    <view class="filter-tabs">
      <view 
        class="tab-item {{currentTab === 'all' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="all"
      >
        <text class="tab-text">å…¨éƒ¨</text>
        <view wx:if="{{stats.total > 0}}" class="tab-badge">{{stats.total}}</view>
      </view>
      <view 
        class="tab-item {{currentTab === 'pending' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="pending"
      >
        <text class="tab-text">å¾…å®Œæˆ</text>
        <view wx:if="{{stats.pending > 0}}" class="tab-badge pending">{{stats.pending}}</view>
      </view>
      <view 
        class="tab-item {{currentTab === 'completed' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="completed"
      >
        <text class="tab-text">å·²å®Œæˆ</text>
        <view wx:if="{{stats.completed > 0}}" class="tab-badge completed">{{stats.completed}}</view>
      </view>
      <view 
        class="tab-item {{currentTab === 'overdue' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="overdue"
      >
        <text class="tab-text">å·²è¿‡æœŸ</text>
        <view wx:if="{{stats.overdue > 0}}" class="tab-badge overdue">{{stats.overdue}}</view>
      </view>
    </view>

    <!-- å® ç‰©ç­›é€‰ -->
    <view class="pet-filter" wx:if="{{pets.length > 1}}">
      <scroll-view class="pet-scroll" scroll-x="true">
        <view class="pet-chips">
          <view 
            class="pet-chip {{selectedPetId === '' ? 'active' : ''}}"
            bindtap="onPetFilter"
            data-pet-id=""
          >
            <text class="chip-text">å…¨éƒ¨å® ç‰©</text>
          </view>
          <view 
            wx:for="{{pets}}" 
            wx:key="_id"
            class="pet-chip {{selectedPetId === item._id ? 'active' : ''}}"
            bindtap="onPetFilter"
            data-pet-id="{{item._id}}"
          >
            <image 
              wx:if="{{item.avatar}}" 
              class="chip-avatar" 
              src="{{item.avatar}}" 
              mode="aspectFill"
            />
            <view wx:else class="chip-avatar-placeholder">{{item.name.charAt(0)}}</view>
            <text class="chip-text">{{item.name}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ—¶é—´è¡¨å†…å®¹åŒºåŸŸ -->
  <view class="content-section">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{filteredSchedules.length === 0}}" class="empty-container">
      <empty-state
        icon="ğŸ“…"
        title="{{getEmptyTitle()}}"
        description="{{getEmptyDescription()}}"
        action-text="{{pets.length === 0 ? 'æ·»åŠ å® ç‰©' : 'ç”Ÿæˆè®¡åˆ’'}}"
        bind:action="onEmptyAction"
      />
    </view>

    <!-- è®¡åˆ’åˆ—è¡¨ -->
    <view wx:else class="schedule-list">
      <!-- æŒ‰å® ç‰©åˆ†ç»„æ˜¾ç¤º -->
      <view wx:for="{{groupedSchedules}}" wx:key="petId" class="pet-group">
        <view class="pet-header">
          <view class="pet-info">
            <image 
              wx:if="{{item.pet.avatar}}" 
              class="pet-avatar" 
              src="{{item.pet.avatar}}" 
              mode="aspectFill"
            />
            <view wx:else class="pet-avatar-placeholder">{{item.pet.name.charAt(0)}}</view>
            <view class="pet-details">
              <text class="pet-name">{{item.pet.name}}</text>
              <text class="pet-meta">{{getPetMeta(item.pet)}}</text>
            </view>
          </view>
          <view class="pet-stats">
            <text class="stats-text">{{item.schedules.length}}é¡¹è®¡åˆ’</text>
          </view>
        </view>

        <!-- è®¡åˆ’é¡¹åˆ—è¡¨ -->
        <view class="schedule-items">
          <view 
            wx:for="{{item.schedules}}" 
            wx:key="_id"
            wx:for-item="schedule"
            class="schedule-item {{getScheduleStatus(schedule)}}"
            bindtap="onScheduleDetail"
            data-schedule="{{schedule}}"
          >
            <!-- æ—¶é—´è½´çº¿æ¡ -->
            <view class="timeline-line">
              <view class="timeline-dot {{getScheduleStatus(schedule)}}">
                <text class="dot-icon">{{getScheduleIcon(schedule)}}</text>
              </view>
            </view>

            <!-- è®¡åˆ’å†…å®¹ -->
            <view class="schedule-content">
              <view class="schedule-header">
                <view class="schedule-title">
                  <text class="title-text">{{getScheduleTitle(schedule)}}</text>
                  <view class="type-tag {{schedule.type}}">
                    {{schedule.type === 'vaccine' ? 'ç–«è‹—' : 'é©±è™«'}}
                  </view>
                </view>
                <view class="schedule-date">
                  <text class="date-text">{{formatScheduleDate(schedule)}}</text>
                  <tag 
                    text="{{getDateStatusText(schedule)}}" 
                    variant="{{getDateStatus(schedule) === 'overdue' ? 'error' : (getDateStatus(schedule) === 'today' ? 'warning' : (getDateStatus(schedule) === 'completed' ? 'success' : 'info'))}}"
                    size="small"
                    shape="rounded"
                    type="light"
                  />
                </view>
              </view>

              <view class="schedule-meta">
                <view wx:if="{{schedule.type === 'vaccine' && schedule.doseNo}}" class="meta-item">
                  <badge variant="primary" size="small" text="ç¬¬{{schedule.doseNo}}é’ˆ" />
                </view>
                <text wx:if="{{schedule.type === 'deworm' && schedule.dewormType}}" class="meta-item">
                  {{getDewormTypeText(schedule.dewormType)}}
                </text>
                <text wx:if="{{schedule.actualDate}}" class="meta-item completed">
                  å®é™…å®Œæˆï¼š{{formatDate(schedule.actualDate)}}
                </text>
              </view>

              <!-- æ“ä½œæŒ‰é’® -->
              <view class="schedule-actions" wx:if="{{getScheduleStatus(schedule) !== 'completed'}}">
                <button 
                  class="action-btn secondary"
                  bindtap="onMarkComplete"
                  data-schedule="{{schedule}}"
                  catch:tap="stopPropagation"
                >
                  æ ‡è®°å®Œæˆ
                </button>
                <button 
                  class="action-btn primary"
                  bindtap="onEditSchedule"
                  data-schedule="{{schedule}}"
                  catch:tap="stopPropagation"
                >
                  ç¼–è¾‘
                </button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions" wx:if="{{pets.length > 0}}">
    <button class="action-button secondary" bindtap="onGeneratePlan">
      <text class="button-icon">âœ¨</text>
      <text class="button-text">ç”Ÿæˆè®¡åˆ’</text>
    </button>
    <button class="action-button primary" bindtap="onAddSchedule">
      <text class="button-icon">â•</text>
      <text class="button-text">æ·»åŠ è®¡åˆ’</text>
    </button>
  </view>

  <!-- å®Œæˆç¡®è®¤å¼¹çª—ï¼ˆå¤ç”¨é€šç”¨ Dialogï¼‰ -->
  <dialog 
    show="{{showCompleteModal}}" 
    title="æ ‡è®°å®Œæˆ"
    bind:cancel="hideCompleteModal"
    bind:confirm="confirmComplete"
  >
    <view slot>
      <view class="complete-info">
        <text class="complete-title">{{completeSchedule.title}}</text>
        <text class="complete-date">è®¡åˆ’æ—¶é—´ï¼š{{formatDate(completeSchedule.plannedDate)}}</text>
      </view>
      <view class="form-item">
        <text class="form-label">å®é™…å®Œæˆæ—¶é—´</text>
        <picker mode="date" value="{{actualDate}}" end="{{today}}" bindchange="onActualDateChange">
          <view class="date-picker">
            {{actualDate || 'é€‰æ‹©å®Œæˆæ—¥æœŸ'}}
            <text class="picker-arrow">ğŸ“…</text>
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨ (å¯é€‰)</text>
        <textarea class="form-textarea" placeholder="è®°å½•æ¥ç§/é©±è™«çš„å…·ä½“ä¿¡æ¯" value="{{completeNote}}" bindinput="onCompleteNoteChange" maxlength="200" />
      </view>
      <view class="dialog-tips">ç‚¹å‡»â€œç¡®å®šâ€å°†æ ‡è®°è¯¥è®¡åˆ’ä¸ºå·²å®Œæˆ</view>
    </view>
  </dialog>
</view>
